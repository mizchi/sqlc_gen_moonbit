name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: mysql
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping -h localhost -uroot -pmysql"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl just libpq-dev libsqlite3-dev pkg-config sqlite3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install MoonBit CLI
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Moon update
        run: |
          moon update
          # Update test project dependencies
          cd tests/sqlite_native && rm -rf .mooncakes && moon update
          cd ../sqlite_js && rm -rf .mooncakes && moon update
          cd ../d1 && moon update

      - name: Install D1 test dependencies
        run: cd tests/d1 && npm ci

      - name: Run core tests
        run: just --justfile .justfile test-core

      - name: Setup PostgreSQL schema
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d testdb -c "
            CREATE TABLE IF NOT EXISTS users (
              id BIGSERIAL PRIMARY KEY,
              name TEXT NOT NULL,
              email TEXT NOT NULL UNIQUE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
          "

      - name: Setup MySQL schema
        run: |
          mysql -h 127.0.0.1 -uroot -pmysql testdb -e "
            CREATE TABLE IF NOT EXISTS users (
              id BIGINT PRIMARY KEY AUTO_INCREMENT,
              name VARCHAR(255) NOT NULL,
              email VARCHAR(255) NOT NULL UNIQUE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
          "

      - name: Install postgres_js dependencies
        run: cd examples/postgres_js && npm ci

      - name: Install mysql_js dependencies
        run: cd examples/mysql_js && npm ci

      - name: Run postgres_js test
        run: just --justfile .justfile test-postgres-js

      - name: Run mysql_js test
        run: just --justfile .justfile test-mysql-js
