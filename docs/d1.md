# D1 (Cloudflare Workers) Setup Guide

This guide explains how to use Cloudflare D1 database with MoonBit.

## Prerequisites

- [MoonBit](https://www.moonbitlang.com/) installed
- [sqlc](https://sqlc.dev/) installed
- [Wrangler](https://developers.cloudflare.com/workers/wrangler/) installed
- Cloudflare account

## Project Structure

```
my-project/
├── app/
│   ├── main.mbt
│   └── moon.pkg
├── db/
│   ├── schema.sql
│   ├── sqlite/
│   │   └── query.sql
│   └── gen/           # Generated by sqlc generate
│       ├── moon.pkg
│       ├── sqlc_queries.mbt
│       └── sqlc_types.mbt
├── moon.mod.json
├── sqlc.yaml
└── wrangler.toml
```

## Setup Steps

### 1. Create MoonBit Project

```bash
mkdir my-d1-project && cd my-d1-project
moon new .
```

### 2. Configure moon.mod.json

```json
{
  "name": "my_d1_project",
  "version": "0.0.1",
  "deps": {
    "mizchi/js": "0.10.10",
    "mizchi/cloudflare": "0.1.6",
    "moonbitlang/async": "0.16.0"
  },
  "supported-targets": ["js"]
}
```

Install dependencies:

```bash
moon update
```

### 3. Create sqlc.yaml

```yaml
version: "2"
plugins:
  - name: moonbit
    wasm:
      url: "https://github.com/mizchi/sqlc_gen_moonbit/releases/download/v0.2.1/sqlc-gen-moonbit.wasm"
      sha256: "c12dd1b4984b83b7ca97930c329779a9bd2c1505a650f7417638bdf00426e57f"
sql:
  - engine: sqlite
    schema: "db/schema.sql"
    queries: "db/sqlite/query.sql"
    codegen:
      - plugin: moonbit
        out: "db/gen"
        options:
          backend: "d1"
```

### 4. Create Schema and Queries

`db/schema.sql`:

```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

`db/sqlite/query.sql`:

```sql
-- name: GetUser :one
SELECT * FROM users WHERE id = ?;

-- name: ListUsers :many
SELECT * FROM users ORDER BY name;

-- name: CreateUser :execlastid
INSERT INTO users (name, email) VALUES (?, ?);

-- name: UpdateUser :execrows
UPDATE users SET name = ?, email = ? WHERE id = ?;

-- name: DeleteUser :execrows
DELETE FROM users WHERE id = ?;
```

### 5. Generate Code

```bash
sqlc generate
```

This generates the following files in `db/gen/`:
- `sqlc_types.mbt` - Type definitions
- `sqlc_queries.mbt` - Query functions

### 6. Create moon.pkg Files

`db/gen/moon.pkg`:

```json
{
  "import": [
    "mizchi/cloudflare",
    "mizchi/js/async"
  ]
}
```

`app/moon.pkg`:

```json
{
  "is-main": true,
  "import": [
    { "path": "my_d1_project/db/gen", "alias": "gen" },
    "mizchi/cloudflare",
    "mizchi/cloudflare/http",
    "mizchi/cloudflare/url",
    "mizchi/js",
    "mizchi/js/json"
  ],
  "link": {
    "js": {
      "exports": ["get_handler"],
      "format": "esm"
    }
  }
}
```

### 7. Create Worker Code

`app/main.mbt`:

```moonbit
///|
using @js { promisify3 }

///|
using @http { type Response }

///|
using @url { type URL }

///|
extern "js" fn json_response(body : String, status : Int) -> Response =
  #| (body, status) => new Response(body, { status, headers: { "Content-Type": "application/json" } })

///|
fn get_db(env : @cloudflare.CloudflareEnv) -> @cloudflare.D1Database? {
  let env_js : @core.Any = @core.identity(env)
  let db_js = env_js._get("DB")
  if @core.typeof_(db_js) == "undefined" {
    None
  } else {
    Some(@core.identity(db_js))
  }
}

///|
pub fn get_handler() -> @cloudflare.CloudflareFetchHandler {
  let async_handler = async fn(
    req : @cloudflare.CloudflareRequest,
    env : @cloudflare.CloudflareEnv,
    _ctx : @cloudflare.CloudflareContext,
  ) -> Response {
    let url = URL::new(req.url)
    let pathname = url.pathname

    let db = match get_db(env) {
      Some(d) => d
      None => return json_response("{\"error\":\"D1 database not configured\"}", 500)
    }

    if pathname == "/users" {
      let users = @gen.list_users(db) catch {
        e => return json_response("{\"error\":\"" + e.to_string() + "\"}", 500)
      }
      let result = @core.new_object()
      result["users"] = @core.any(users)
      json_response(@json.JSON::stringify(result), 200)
    } else {
      json_response("{\"error\":\"Not Found\"}", 404)
    }
  }
  promisify3(async_handler)
}
```

### 8. Create wrangler.toml

```toml
name = "my-d1-worker"
main = "target/js/release/build/app/app.js"
compatibility_date = "2024-01-01"

[[d1_databases]]
binding = "DB"
database_name = "my-database"
database_id = "<YOUR_DATABASE_ID>"
```

### 9. Create D1 Database

```bash
# Create database
wrangler d1 create my-database

# Apply schema
wrangler d1 execute my-database --file=db/schema.sql
```

### 10. Build and Deploy

```bash
# Build
moon build --target js

# Local development
wrangler dev

# Deploy
wrangler deploy
```

## Query Types

| Annotation | Return Type | Description |
|------------|-------------|-------------|
| `:one` | `T?` | Single row or None |
| `:many` | `Array[T]` | Multiple rows |
| `:exec` | `Unit` | Execute only (no return value) |
| `:execlastid` | `Int` | last_insert_rowid after insert |
| `:execrows` | `Int` | Number of affected rows |

## Error Handling

The D1 backend query functions raise `@cloudflare.D1Error`:

```moonbit
let users = @gen.list_users(db) catch {
  e => {
    println("Error: " + e.to_string())
    return
  }
}
```

## References

- [Complete example](../examples/d1/)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
- [MoonBit Cloudflare Library](https://mooncakes.io/docs/#/mizchi/cloudflare/)
