# PostgreSQL Native Setup Guide

This guide explains how to use PostgreSQL database with MoonBit native binaries.

## Prerequisites

- [MoonBit](https://www.moonbitlang.com/) installed
- [sqlc](https://sqlc.dev/) installed
- libpq (PostgreSQL client library) installed
- PostgreSQL server available

### Installing libpq

**macOS:**
```bash
brew install libpq
```

**Ubuntu/Debian:**
```bash
sudo apt-get install libpq-dev
```

## Project Structure

```
my-project/
├── app/
│   ├── main.mbt
│   └── moon.pkg
├── db/
│   ├── postgres/
│   │   ├── schema.sql
│   │   └── query.sql
│   └── gen/           # Generated by sqlc generate
│       ├── moon.pkg
│       ├── sqlc_queries.mbt
│       └── sqlc_types.mbt
├── moon.mod.json
└── sqlc.yaml
```

## Setup Steps

### 1. Create MoonBit Project

```bash
mkdir my-postgres-project && cd my-postgres-project
moon new .
```

### 2. Configure moon.mod.json

```json
{
  "name": "my_postgres_project",
  "version": "0.0.1",
  "deps": {
    "mattn/postgres": "0.10.4",
    "moonbitlang/x": "0.4.38"
  },
  "supported-targets": ["native"]
}
```

Install dependencies:

```bash
moon update
```

### 3. Create sqlc.yaml

```yaml
version: "2"
plugins:
  - name: moonbit
    wasm:
      url: "https://github.com/mizchi/sqlc_gen_moonbit/releases/download/v0.2.1/sqlc-gen-moonbit.wasm"
      sha256: "c12dd1b4984b83b7ca97930c329779a9bd2c1505a650f7417638bdf00426e57f"
sql:
  - engine: postgresql
    schema: "db/postgres/schema.sql"
    queries: "db/postgres/query.sql"
    codegen:
      - plugin: moonbit
        out: "db/gen"
        options:
          backend: "postgres"
```

### 4. Create Schema and Queries

`db/postgres/schema.sql`:

```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

`db/postgres/query.sql`:

```sql
-- name: GetUser :one
SELECT * FROM users WHERE id = $1;

-- name: ListUsers :many
SELECT * FROM users ORDER BY id;

-- name: CreateUser :execlastid
INSERT INTO users (name, email) VALUES ($1, $2) RETURNING id;

-- name: UpdateUser :execrows
UPDATE users SET name = $2, email = $3 WHERE id = $1;

-- name: DeleteUser :exec
DELETE FROM users WHERE id = $1;
```

**Note:** PostgreSQL uses `$1`, `$2`, `$3` for placeholders (different from SQLite's `?`).

### 5. Generate Code

```bash
sqlc generate
```

This generates the following files in `db/gen/`:
- `sqlc_types.mbt` - Type definitions
- `sqlc_queries.mbt` - Query functions

### 6. Create moon.pkg Files

`db/gen/moon.pkg`:

```json
{
  "import": [
    "mattn/postgres",
    "moonbitlang/x/strconv"
  ]
}
```

`app/moon.pkg`:

```json
{
  "is-main": true,
  "import": [
    { "path": "my_postgres_project/db/gen", "alias": "gen" },
    "mattn/postgres"
  ]
}
```

### 7. Create Application Code

`app/main.mbt`:

```moonbit
///|
fn main {
  // Connection URL (recommend using environment variable)
  let url = "postgres://user:password@localhost:5432/mydb"

  // Connect to database
  let conn = @postgres.Connection::new(url)
  guard conn.connect() == @postgres.ConnStatus::Ok else {
    println("Failed to connect: " + conn.error_message())
    return
  }
  println("Connected to PostgreSQL")

  // Create user
  match @gen.create_user(conn, @gen.CreateUserParams::new("Alice", "alice@example.com")) {
    Ok(id) => println("Created user with id: " + id.to_string())
    Err(e) => println("Error: " + e.to_string())
  }

  // List all users
  match @gen.list_users(conn) {
    Ok(users) => {
      println("Users (" + users.length().to_string() + "):")
      for user in users {
        println("  " + user.id.to_string() + ": " + user.name + " <" + user.email + ">")
      }
    }
    Err(e) => println("Error: " + e.to_string())
  }

  // Get single user
  match @gen.get_user(conn, @gen.GetUserParams::new(1L)) {
    Ok(Some(user)) => println("Found: " + user.name)
    Ok(None) => println("User not found")
    Err(e) => println("Error: " + e.to_string())
  }

  // Update user
  match @gen.update_user(conn, @gen.UpdateUserParams::new(1L, "Alice Smith", "alice.smith@example.com")) {
    Ok(count) => println("Updated " + count.to_string() + " row(s)")
    Err(e) => println("Error: " + e.to_string())
  }

  // Delete user
  match @gen.delete_user(conn, @gen.DeleteUserParams::new(2L)) {
    Ok(_) => println("Deleted user")
    Err(e) => println("Error: " + e.to_string())
  }

  // Close connection
  conn.close()
}
```

### 8. Prepare Database

Apply schema to PostgreSQL:

```bash
psql -U user -d mydb -f db/postgres/schema.sql
```

Or start a temporary database with Docker:

```bash
docker run --rm -p 5432:5432 \
  -e POSTGRES_USER=user \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=mydb \
  postgres:16
```

### 9. Build and Run

```bash
# Build
moon build --target native

# Run
moon run --target native app
```

## Connection URL Format

```
postgres://user:password@host:port/database
```

Examples:
- `postgres://admin:secret@localhost:5432/myapp`
- `postgres://user@localhost/testdb` (no password)

Using environment variables is recommended:

```moonbit
fn main {
  let url = match @env.get("DATABASE_URL") {
    Some(url) => url
    None => {
      println("DATABASE_URL not set")
      return
    }
  }
  let conn = @postgres.Connection::new(url)
  // ...
}
```

## Query Types

| Annotation | Return Type | Description |
|------------|-------------|-------------|
| `:one` | `Result[T?, PgError]` | Single row or None |
| `:many` | `Result[Array[T], PgError]` | Multiple rows |
| `:exec` | `Result[Unit, PgError]` | Execute only |
| `:execlastid` | `Result[Int64, PgError]` | INSERT RETURNING id |
| `:execrows` | `Result[Int, PgError]` | Number of affected rows |

## Type Mapping

| PostgreSQL Type | MoonBit Type |
|-----------------|--------------|
| INTEGER, INT4 | Int |
| BIGINT, INT8 | Int64 |
| SMALLINT | Int |
| SERIAL | Int64 |
| VARCHAR, TEXT, CHAR | String |
| BOOLEAN | Bool |
| REAL, FLOAT4 | Float |
| DOUBLE PRECISION, FLOAT8 | Double |
| TIMESTAMP, TIMESTAMPTZ | String |
| DATE | String |
| NULL | Option[T] |

## Error Handling

PostgreSQL backend query functions return `Result[T, @postgres.PgError]`:

```moonbit
match @gen.list_users(conn) {
  Ok(users) => {
    // Success
    for user in users {
      println(user.name)
    }
  }
  Err(e) => {
    // Error
    println("Database error: " + e.to_string())
  }
}
```

## Transactions

```moonbit
// Begin transaction
conn.query("BEGIN") |> ignore

// ... execute multiple queries

// Commit
conn.query("COMMIT") |> ignore

// Or rollback
// conn.query("ROLLBACK") |> ignore
```

## References

- [Complete example](../examples/postgres_native/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [MoonBit PostgreSQL Library](https://mooncakes.io/docs/#/mattn/postgres/)
