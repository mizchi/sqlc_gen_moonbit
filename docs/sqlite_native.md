# SQLite Native Setup Guide

This guide explains how to use SQLite database with MoonBit native binaries.

## Prerequisites

- [MoonBit](https://www.moonbitlang.com/) installed
- [sqlc](https://sqlc.dev/) installed
- SQLite3 library installed on your system

## Project Structure

```
my-project/
├── app/
│   ├── main.mbt
│   └── moon.pkg
├── db/
│   ├── sqlite/
│   │   ├── schema.sql
│   │   └── query.sql
│   └── gen/           # Generated by sqlc generate
│       ├── moon.pkg
│       ├── sqlc_queries.mbt
│       └── sqlc_types.mbt
├── moon.mod.json
└── sqlc.yaml
```

## Setup Steps

### 1. Create MoonBit Project

```bash
mkdir my-sqlite-project && cd my-sqlite-project
moon new .
```

### 2. Configure moon.mod.json

```json
{
  "name": "my_sqlite_project",
  "version": "0.0.1",
  "deps": {
    "mizchi/sqlite": "0.1.3",
    "moonbitlang/x": "0.4.38"
  },
  "supported-targets": ["native"]
}
```

Install dependencies:

```bash
moon update
```

### 3. Create sqlc.yaml

```yaml
version: "2"
plugins:
  - name: moonbit
    wasm:
      url: "https://github.com/mizchi/sqlc_gen_moonbit/releases/download/v0.2.1/sqlc-gen-moonbit.wasm"
      sha256: "c12dd1b4984b83b7ca97930c329779a9bd2c1505a650f7417638bdf00426e57f"
sql:
  - engine: sqlite
    schema: "db/sqlite/schema.sql"
    queries: "db/sqlite/query.sql"
    codegen:
      - plugin: moonbit
        out: "db/gen"
        options:
          backend: "sqlite"
```

### 4. Create Schema and Queries

`db/sqlite/schema.sql`:

```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

`db/sqlite/query.sql`:

```sql
-- name: GetUser :one
SELECT * FROM users WHERE id = ?;

-- name: ListUsers :many
SELECT * FROM users ORDER BY name;

-- name: CreateUser :execlastid
INSERT INTO users (name, email) VALUES (?, ?);

-- name: UpdateUser :execrows
UPDATE users SET name = ?, email = ? WHERE id = ?;

-- name: DeleteUser :execrows
DELETE FROM users WHERE id = ?;
```

### 5. Generate Code

```bash
sqlc generate
```

This generates the following files in `db/gen/`:
- `sqlc_types.mbt` - Type definitions
- `sqlc_queries.mbt` - Query functions

### 6. Create moon.pkg Files

`db/gen/moon.pkg`:

```json
{
  "import": [
    "mizchi/sqlite"
  ]
}
```

`app/moon.pkg`:

```json
{
  "is-main": true,
  "import": [
    { "path": "my_sqlite_project/db/gen", "alias": "gen" },
    "mizchi/sqlite",
    "moonbitlang/x/encoding"
  ]
}
```

### 7. Create Application Code

`app/main.mbt`:

```moonbit
///|
fn cstring(s : String) -> Bytes {
  @encoding.encode(@encoding.UTF8, s)
}

///|
fn exec_sql(db : @sqlite.Sqlite3, sql : String) -> Unit {
  let stmt = @sqlite.sqlite_prepare(db, cstring(sql))
  @sqlite.sqlite_step(stmt) |> ignore
  @sqlite.sqlite_finalize(stmt)
}

///|
fn main {
  // Open in-memory database
  let db = @sqlite.sqlite_open_v2(
    cstring(":memory:"),
    @sqlite.SQLITE_OPEN_READWRITE | @sqlite.SQLITE_OPEN_CREATE | @sqlite.SQLITE_OPEN_MEMORY,
    Bytes::new(0),
  )

  // Create schema
  exec_sql(db, "CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, email TEXT NOT NULL UNIQUE, created_at TEXT NOT NULL DEFAULT (datetime('now')))")
  println("Created users table")

  // Create users
  let id1 = @gen.create_user(db, @gen.CreateUserParams::new("Alice", "alice@example.com"))
  let id2 = @gen.create_user(db, @gen.CreateUserParams::new("Bob", "bob@example.com"))
  println("Created users: id=" + id1.to_string() + ", " + id2.to_string())

  // List all users
  let users = @gen.list_users(db)
  println("Users (" + users.length().to_string() + "):")
  for user in users {
    println("  " + user.id.to_string() + ": " + user.name + " <" + user.email + ">")
  }

  // Get single user
  match @gen.get_user(db, @gen.GetUserParams::new(1L)) {
    Some(user) => println("Found: " + user.name)
    None => println("Not found")
  }

  // Update user
  let updated = @gen.update_user(db, @gen.UpdateUserParams::new("Alice Smith", "alice.smith@example.com", 1L))
  println("Updated " + updated.to_string() + " row(s)")

  // Delete user
  let deleted = @gen.delete_user(db, @gen.DeleteUserParams::new(2L))
  println("Deleted " + deleted.to_string() + " row(s)")

  // Final count
  let final_users = @gen.list_users(db)
  println("Final user count: " + final_users.length().to_string())
}
```

### 8. Build and Run

```bash
# Build
moon build --target native

# Run
moon run --target native app
```

## File-based Database

To use a file-based database instead of in-memory:

```moonbit
let db = @sqlite.sqlite_open_v2(
  cstring("./data.db"),
  @sqlite.SQLITE_OPEN_READWRITE | @sqlite.SQLITE_OPEN_CREATE,
  Bytes::new(0),
)
```

## Query Types

| Annotation | Return Type | Description |
|------------|-------------|-------------|
| `:one` | `T?` | Single row or None |
| `:many` | `Array[T]` | Multiple rows |
| `:exec` | `Unit` | Execute only (no return value) |
| `:execlastid` | `Int64` | last_insert_rowid after insert |
| `:execrows` | `Int64` | Number of affected rows |

## Type Mapping

| SQLite Type | MoonBit Type |
|-------------|--------------|
| INTEGER | Int64 |
| TEXT | String |
| REAL | Double |
| BLOB | Bytes |
| NULL | Option[T] |

## Transactions

```moonbit
exec_sql(db, "BEGIN TRANSACTION")
// ... execute multiple queries
exec_sql(db, "COMMIT")
```

Rollback on error:

```moonbit
exec_sql(db, "BEGIN TRANSACTION")
// ... execute queries
// If an error occurs
exec_sql(db, "ROLLBACK")
```

## References

- [Complete example](../examples/sqlite_native/)
- [SQLite Documentation](https://sqlite.org/docs.html)
- [MoonBit SQLite Library](https://mooncakes.io/docs/#/mizchi/sqlite/)
