// Generated by sqlc-gen-moonbit (backend: postgres_js)
// Requires: mizchi/npm_typed/pg

///| Convert JavaScript number to Int64
extern "js" fn js_number_to_int64(v : @core.Any) -> Int64 =
  #| (v) => { const n = Number(v); return { hi: Math.floor(n / 0x100000000), lo: n >>> 0 }; }

///| Convert Int64 to JavaScript number
extern "js" fn int64_to_js_number(v : Int64) -> @core.Any =
  #| (v) => v.hi * 0x100000000 + (v.lo >>> 0)

// Query functions
///| GetUser
/// SELECT id, name, email, created_at FROM users WHERE id = $1
pub async fn get_user(pool : @pg.Pool, params : GetUserParams) -> GetUserRow? {
  let result = pool.query(get_user_sql, params=[int64_to_js_number(params.id)])
  let rows = result.rows()
  let len : Int = rows["length"].cast()
  if len == 0 {
    None
  } else {
    let row = rows._get_by_index(0)
    Some({
      id: js_number_to_int64(row["id"]),
      name: row["name"].cast(),
      email: row["email"].cast(),
      created_at: (if @core.is_null(row["created_at"]) || @core.typeof_(row["created_at"]) == "undefined" { None } else { Some(row["created_at"].cast()) }),
    })
  }
}

///| ListUsers
/// SELECT id, name, email, created_at FROM users ORDER BY id
pub async fn list_users(pool : @pg.Pool) -> Array[ListUsersRow] {
  let result = pool.query(list_users_sql)
  let rows = result.rows()
  let len : Int = rows["length"].cast()
  let results : Array[ListUsersRow] = []
  for i = 0; i < len; i = i + 1 {
    let row = rows._get_by_index(i)
    results.push({
      id: js_number_to_int64(row["id"]),
      name: row["name"].cast(),
      email: row["email"].cast(),
      created_at: (if @core.is_null(row["created_at"]) || @core.typeof_(row["created_at"]) == "undefined" { None } else { Some(row["created_at"].cast()) }),
    })
  }
  results
}

///| CreateUser
/// INSERT INTO users (name, email) VALUES ($1, $2) RETURNING id
pub async fn create_user(pool : @pg.Pool, params : CreateUserParams) -> Int64 {
  let result = pool.query(create_user_sql, params=[@core.any(params.name), @core.any(params.email)])
  let rows = result.rows()
  let len : Int = rows["length"].cast()
  if len > 0 {
    let row = rows._get_by_index(0)
    js_number_to_int64(row["id"])
  } else {
    0L
  }
}

///| UpdateUser
/// UPDATE users SET name = $2, email = $3 WHERE id = $1
pub async fn update_user(pool : @pg.Pool, params : UpdateUserParams) -> Int {
  let result = pool.query(update_user_sql, params=[int64_to_js_number(params.id), @core.any(params.name), @core.any(params.email)])
  result.rowCount()
}

///| DeleteUser
/// DELETE FROM users WHERE id = $1
pub async fn delete_user(pool : @pg.Pool, params : DeleteUserParams) -> Unit {
  let result = pool.query(delete_user_sql, params=[int64_to_js_number(params.id)])
  ignore(result)
}

