// Generated by sqlc-gen-moonbit (backend: sqlite_js)
// Requires: mizchi/sqlite (JS target)

///|
fn bytes_to_string(b : Bytes) -> String {
  let decoder = @encoding.decoder(@encoding.UTF8)
  decoder.decode_lossy(b[0:b.length()])
}

// Query functions
///| GetUser
/// SELECT id, name, email, created_at FROM users WHERE id = ?
pub fn get_user(db : @sqlite.Database, params : GetUserParams) -> GetUserRow? raise SqlError {
  let stmt = match db.prepare(get_user_sql) {
    Some(s) => s
    None => raise SqlError(bytes_to_string(db.errmsg()))
  }
  stmt.bind(1, @sqlite.Int(params.id)) |> ignore
  if stmt.step() {
    let row : GetUserRow = {
      id: stmt.column_int(0),
      name: bytes_to_string(stmt.column_text(1)),
      email: bytes_to_string(stmt.column_text(2)),
      created_at: bytes_to_string(stmt.column_text(3)),
    }
    stmt.finalize()
    Some(row)
  } else {
    stmt.finalize()
    None
  }
}

///| ListUsers
/// SELECT id, name, email, created_at FROM users ORDER BY name
pub fn list_users(db : @sqlite.Database) -> Array[ListUsersRow] raise SqlError {
  let stmt = match db.prepare(list_users_sql) {
    Some(s) => s
    None => raise SqlError(bytes_to_string(db.errmsg()))
  }
  let results : Array[ListUsersRow] = []
  while stmt.step() {
    let row : ListUsersRow = {
      id: stmt.column_int(0),
      name: bytes_to_string(stmt.column_text(1)),
      email: bytes_to_string(stmt.column_text(2)),
      created_at: bytes_to_string(stmt.column_text(3)),
    }
    results.push(row)
  }
  stmt.finalize()
  results
}

///| CreateUser
/// INSERT INTO users (name, email) VALUES (?, ?)
pub fn create_user(db : @sqlite.Database, params : CreateUserParams) -> Int64 raise SqlError {
  let stmt = match db.prepare(create_user_sql) {
    Some(s) => s
    None => raise SqlError(bytes_to_string(db.errmsg()))
  }
  stmt.bind(1, @sqlite.Text(@encoding.encode(@encoding.UTF8, params.name))) |> ignore
  stmt.bind(2, @sqlite.Text(@encoding.encode(@encoding.UTF8, params.email))) |> ignore
  stmt.execute() |> ignore
  stmt.finalize()
  db.last_insert_rowid()
}

///| UpdateUser
/// UPDATE users SET name = ?, email = ? WHERE id = ?
pub fn update_user(db : @sqlite.Database, params : UpdateUserParams) -> Int raise SqlError {
  let stmt = match db.prepare(update_user_sql) {
    Some(s) => s
    None => raise SqlError(bytes_to_string(db.errmsg()))
  }
  stmt.bind(1, @sqlite.Text(@encoding.encode(@encoding.UTF8, params.name))) |> ignore
  stmt.bind(2, @sqlite.Text(@encoding.encode(@encoding.UTF8, params.email))) |> ignore
  stmt.bind(3, @sqlite.Int(params.id)) |> ignore
  stmt.execute() |> ignore
  stmt.finalize()
  db.changes()
}

///| DeleteUser
/// DELETE FROM users WHERE id = ?
pub fn delete_user(db : @sqlite.Database, params : DeleteUserParams) -> Int raise SqlError {
  let stmt = match db.prepare(delete_user_sql) {
    Some(s) => s
    None => raise SqlError(bytes_to_string(db.errmsg()))
  }
  stmt.bind(1, @sqlite.Int(params.id)) |> ignore
  stmt.execute() |> ignore
  stmt.finalize()
  db.changes()
}

